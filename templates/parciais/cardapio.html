<div class="container-xxl py-5" id="cardapio">
    <div class="container">
        <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
            <h5 class="section-title ff-secondary text-center text-primary fw-normal">Opções de Chopp</h5>
            <h1 class="mb-5">Mais Populares</h1>
        </div>
        <div class="tab-class text-center wow fadeInUp" data-wow-delay="0.1s">
            <ul class="nav nav-pills d-inline-flex justify-content-center border-bottom mb-5">
                <!-- Opções de Chopp aqui -->
            </ul>
            <div class="tab-content">
                <div id="tab-1" class="tab-pane fade show p-0 active">
                    <div class="row g-4">
                        {% for produto in produtos %}
                        <div class="col-lg-6">
                            <div class="d-flex align-items-center">
                                {% comment %} <img class="flex-shrink-0 img-fluid rounded" src="{{ produto.imagem.url }}" alt="" style="width: 80px;"> {% endcomment %}
                                <div class="w-100 d-flex flex-column text-start ps-4">
                                    <h5 class="d-flex justify-content-between border-bottom pb-2">
                                        <span>{{ produto.nome }} - {{ produto.litros }} L</span>
                                        <span class="text-primary">{{ produto.valor }}</span>
                                    </h5>
                                    <!-- Botão Adicionar ao Carrinho -->
                                    <button class="btn btn-primary add-to-cart" data-id="{{ produto.id }}" data-nome="{{ produto.nome }}" data-valor="{{ produto.valor }}">
                                        Adicionar ao Carrinho
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Carrinho de Compras -->
        <div class="mt-5">
            <h3>Carrinho de Compras</h3>
            <ul id="cart-items" class="list-group mb-3">
                <!-- Itens do Carrinho serão adicionados dinamicamente aqui -->
            </ul>
            <button id="checkout-button" class="btn btn-success">Pagar</button>
        </div>
    </div>
</div>

<script>
    // Armazena o carrinho de compras
    let cart = [];

    // Adiciona um produto ao carrinho
    function addToCart(produtoId, nome, valor) {
        const item = { id: produtoId, nome: nome, valor: parseFloat(valor) };
        cart.push(item);
        updateCartUI();
    }

    // Atualiza a interface de usuário do carrinho
    function updateCartUI() {
        const cartItems = document.getElementById('cart-items');
        cartItems.innerHTML = '';

        cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = `${item.nome} - R$${item.valor.toFixed(2)}`;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-danger btn-sm';
            removeBtn.textContent = 'Remover';
            removeBtn.onclick = () => {
                removeFromCart(index);
            };
            li.appendChild(removeBtn);
            cartItems.appendChild(li);
        });
    }

    // Remove um produto do carrinho
    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartUI();
    }

    // Configura o botão de adicionar ao carrinho
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function () {
            const produtoId = this.getAttribute('data-id');
            const nome = this.getAttribute('data-nome');
            const valor = this.getAttribute('data-valor');
            addToCart(produtoId, nome, valor);
        });
    });

    // Processa o pagamento quando o botão de pagamento é clicado
    document.getElementById('checkout-button').addEventListener('click', function () {
        if (cart.length === 0) {
            alert('Seu carrinho está vazio!');
            return;
        }

        // Faz uma solicitação POST para criar o link de pagamento
        fetch("{% url 'create_payment_link' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ cart: cart })  // Corrigido o formato de envio do carrinho
        })
        .then(response => response.json())
        .then(data => {
            if (data.init_point) {
                // Redireciona para o link de pagamento do MercadoPago
                window.location.href = data.init_point;
            } else {
                console.error('Erro ao gerar link de pagamento:', data);
                alert('Erro ao gerar link de pagamento. Tente novamente.');
            }
        })
        .catch(error => console.error('Erro na solicitação:', error));
    });
</script>
